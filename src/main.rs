extern crate pretty_env_logger;
#[macro_use]
extern crate log;

use async_std::task;
use async_tun::result::Result;
use std::sync::Arc;

mod config;
mod constants;
mod context;
mod data;
mod handlers;
mod honeypots;
mod net;
mod suricata;
mod types;
use config::Config;
use context::AppContext;
use honeypots::setup_honeypots;
use net::init::get_tun_in;
use net::init::get_tun_out;
use net::init::setup_iptables;
use net::tun_handler::create_handlers;
use suricata::suricata_monitor;

/// Async main function
async fn async_main<'a>() -> Result<()> {
    // Initialize logger
    pretty_env_logger::init();
    // Load config
    let mut filename = "config.yaml";
    // Get filename from arg if present
    let args: Vec<String> = std::env::args().collect();
    for i in 0..args.len() {
        if args[i] == "-c" {
            filename = &args[i + 1];
        }
    }
    let config = Config::load(filename);
    // Initialize context
    let ctx = AppContext::new(config);

    // Setup honeypots
    setup_honeypots(Arc::clone(&ctx)).await?;

    // Create tun interfaces
    let tun_in = get_tun_in().await?;
    let tun_out = get_tun_out().await?;
    setup_iptables();

    // Run
    warn!("Running");

    let proc1 = create_handlers(Arc::clone(&ctx), tun_in, tun_out);
    let proc2 = suricata_monitor(Arc::clone(&ctx));
    proc1.await?;
    proc2.await?;
    Ok(())
}

fn main() -> Result<()> {
    task::block_on(async_main())
}
