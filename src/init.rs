use async_tun::result::Result;
use async_tun::Tun;
use async_tun::TunBuilder;
use std::net::Ipv4Addr;
use std::process::Command;

/// Get the tun interface for the inbound traffic
pub async fn get_tun_in() -> Result<Tun> {
    return TunBuilder::new()
        .name("")
        .tap(false)
        .packet_info(false)
        .mtu(1500)
        .up()
        .address(Ipv4Addr::new(10, 0, 0, 1))
        //.destination(Ipv4Addr::new(10, 1, 0, 1))
        .broadcast(Ipv4Addr::BROADCAST)
        .netmask(Ipv4Addr::new(255, 255, 255, 0))
        .try_build()
        .await;
}

/// Get the tun interface for the outside world
pub async fn get_tun_out() -> Result<Tun> {
    return TunBuilder::new()
        .name("")
        .tap(false)
        .packet_info(false)
        .mtu(1500)
        .up()
        .address(Ipv4Addr::new(10, 2, 0, 0))
        .destination(Ipv4Addr::new(10, 2, 0, 1))
        .broadcast(Ipv4Addr::BROADCAST)
        .netmask(Ipv4Addr::new(255, 255, 255, 0))
        .try_build()
        .await;
}

/// Run iptables commands to set up the routing.
pub fn setup_iptables() {
    Command::new("iptables")
        .args([
            "-t",
            "nat",
            "-A",
            "POSTROUTING",
            "-o",
            "eth0",
            "-j",
            "MASQUERADE",
        ])
        .output();
    Command::new("iptables")
        .args([
            "-t",
            "nat",
            "-A",
            "POSTROUTING",
            "-s",
            "10.2.0.0/24",
            "-j",
            "MASQUERADE",
        ])
        .output();
    Command::new("iptables")
        .args([
            "-t",
            "filter",
            "-A",
            "FORWARD",
            "-i",
            "tun1",
            "-s",
            "10.2.0.0/24",
            "-j",
            "ACCEPT",
        ])
        .output();
    Command::new("iptables")
        .args([
            "-t",
            "filter",
            "-A",
            "FORWARD",
            "-o",
            "tun1",
            "-s",
            "10.2.0.0/24",
            "-j",
            "ACCEPT",
        ])
        .output();
    Command::new("iptables")
        .args([
            "-t", "filter", "-A", "FORWARD", "-i", "tun1", "-o", "eth0", "-j", "ACCEPT",
        ])
        .output();
    Command::new("iptables")
        .args([
            "-t",
            "filter",
            "-A",
            "FORWARD",
            "-m",
            "state",
            "--state",
            "ESTABLISHED,RELATED",
            "-j",
            "ACCEPT",
        ])
        .output();

    //Command::new("./connect-iface.sh").output();
}
