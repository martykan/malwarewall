extern crate pretty_env_logger;
#[macro_use]
extern crate log;

use async_std::task;
use async_tun::result::Result;
use std::sync::Arc;

mod config;
mod constants;
mod context;
mod data;
mod handlers;
mod net;
mod suricata;
mod types;
use config::Config;
use context::AppContext;
use net::init::get_tun_in;
use net::init::get_tun_out;
use net::init::setup_iptables;
use net::tun_handler::create_handlers;
use suricata::suricata_monitor;

/// Async main function
async fn async_main<'a>() -> Result<()> {
    // Initialize logger
    pretty_env_logger::init();
    // Load config
    let config = Config::load();
    // Initialize context
    let ctx = AppContext::new(config);

    // Create tun interfaces
    let tun_in = get_tun_in().await?;
    let tun_out = get_tun_out().await?;
    setup_iptables();

    // Run
    info!("-----------");
    info!(" Running   ");
    info!("-----------");

    let proc1 = create_handlers(Arc::clone(&ctx), tun_in, tun_out);
    let proc2 = suricata_monitor(Arc::clone(&ctx));
    proc1.await?;
    proc2.await?;
    Ok(())
}

fn main() -> Result<()> {
    task::block_on(async_main())
}
